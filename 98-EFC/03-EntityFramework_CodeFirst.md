# Entity Framework: Code First

## Code first doesn’t always mean code first
尽管名称 `code first` 意味着数据库在编写代码之前不存在，但完全有可能对现有数据库以及新的绿地项目采用代码优先方法。与任何开发方案一样，在尝试确定代码优先方法是否适合您的项目时，需要考虑多种因素。

### When not to use the code-first approach
有时，当试图确定某件事何时是正确答案时，开始的方法是确定它何时不是正确答案。话虽这么说，在当今世界你会遇到的大多数生产应用程序中，代码优先没有多大意义的原因很少。  避免使用代码优先方法的主要原因与拥有无法支持所需工具的遗留系统有关。例如，在 .Net 3.5 之前的任何 .Net Framework 中编写的项目。在那些项目中，Entity Framework 并不存在，因此根本不可能使用代码优先方法。  
您可能被迫避免代码优先方法的另一个原因可能是组织限制。也许有更大的安全问题在起作用，这使得您的公司通过代码向任何开发人员公开对数据结构的如此多的权力是违法的或非常危险的。也许您的公司不允许任何人出于任何原因访问数据库，除了那个神秘的 DBA。在上述两种情况下，可能有一些培训或教育可以克服这些问题，或者在您的开发工作中使用代码优先可能真的是不可能的。  
避免在 EF 中使用代码优先方法的另一个原因可能是个人偏好。也许您不喜欢使用 ORM 所需的规范化结构。您可能还有其他更喜欢用于数据库交互的解决方案，例如 F# 类型提供程序（也可以与 EF 并行使用）。也许您一直在使用 NHibernate 并且您不想更改您知道已经有效的东西，尽管您也可以使用 NHibernate 实现代码优先解决方案。  
避免使用代码优先的最后一个原因可能只是因为在成熟的数据库中丢失数据的风险很高（这与运行任何删除列或表的数据库脚本可能存在的风险没有什么不同；它不是EF 代码优先，它只会随机丢失数据）。虽然完全有可能通过额外的工作来解决这个问题（就像您正在运行手动脚本一样），但总会有可能（并且可能会）发生忘记计划影响数据的数据库迁移。在将此论点作为不在解决方案中选择代码优先的理由之前，请务必记住，您必须克服传统数据库开发中的相同数据丢失问题，并且解决方案通常完全相同（即返回将数据上传到临时表，运行脚本，恢复数据）。
例如，要处理一个简单的数据丢失操作，完全可以创建一个迁移脚本的来运行备份表中的数据；然后运行迁移以按预期修改表或数据库模式，截断或导致数据丢失；然后完成另一个最终迁移以恢复原始数据的操作。最后的操作可能会修改原始数据以适应新的表结构。此过程几乎与传统上必须使用脚本修改数据库结构的方式相同。这里的额外好处是一切都被记录在案，保证按顺序运行，可测试，可重复，并存储在源代码控制中。因此，正如我们接下来要研究的那样，代码优先方法的优势甚至可以使其成为这种情况下的更好选择。当论点是一个人运行手动操作（包括可能会或可能不会测试的脚本）时，很难与可测试和自动化流程争论。

### When to use the code-first approach
如果您想知道什么时候应该使用代码优先方法，简单地说，答案应该是“每次都可以”。尽管在上一节中讨论的一些独特情况下仍然存在您根本无法使用代码优先方法的情况，但任何时候您可以使用代码优先，您都应该使用代码优先。  
使用 EFCore，不再能够创建模型文件，例如您可能习惯于从早期版本的 EF 中创建的 EDMX 文件。虽然我们总是可以生成一个逆向工程数据库（如第 2 章中所见），但事实是我们很可能会采用基于模型的方法来进行所有的开发。出于几个原因，这是一件非常好的事情。

### Code first in an existing project
既然您已经完全接受并准备好使用 Entity Framework 构建代码优先方法，那么当您有一个现有的成熟项目和现有数据库时，您会怎么做？由于数据库已经存在，您可以从带脚手架的逆向工程方法开始，将代码模型自动生成到您的解决方案中。这种方法还可以确保为您生成并填充 DBContext（如您在第 2 章中所见）。  
使用逆向工程方法，要使项目以代码优先的方式运行，您只需启用迁移并开始针对数据结构进行迁移。  
启用迁移后，从那时起，该项目将能够继续构建新模型和数据库对象，并根据需要使用代码优先方法应用进一步的迁移。  
如果您采用这种方法，请谨慎行事，因为在这种方法中仍然需要非常小心。对于已经成熟的数据库，您需要防止意外更改，这些更改可能会截断表中的数据或破坏关键的性能增强（例如删除视图或索引可能会发生的更改）。如果其他遗留业务线应用程序依赖这些原始数据结构进行正常操作，这一点尤其重要。  

### Code first in a new project against a mature database
以代码优先方式使用实体框架时可能采用的另一种方法是开发一个利用现有数据库的新应用程序。  
在这种情况下，开发团队还需要格外小心，以避免破坏可能依赖于其他现有应用程序的遗留功能。除了保护模式更改不破坏现有的遗留应用程序之外，代码优先项目中所做的任何更改还需要传播到任何遗留应用程序中，以避免可能导致中断或对其他业务部门造成其他潜在的灾难性后果。与任何事情一样，这总是取决于您作为开发人员的工作。您必须确保您所做的更改和升级将通过广泛的回归测试在遗留系统中工作。

### Code first in a new project with a new database
完全未开发的场景是使用代码优先方法的明显选择。即使您出于某种原因不想使用迁移，在某些时候您仍然需要定义如何使用各种数据库对象的数据模型，以便使用 Entity Framework 和 LINQ to EF（LINQ 代表“语言集成”查询”，本书后面将对此进行更详细的介绍）。  
由于新建项目是新的并且伴随着新的数据库，因此首先使用代码将从您的代码库中提供最佳的灵活性和易用性。在这种情况下，只有使用代码优先方法才有意义。


## The benefits of a well-executed code-first development effort
如果对您的团队使用代码优先方法所能取得的成功水平仍有任何疑问，我想花点时间强调一下使用代码优先方法的一些最大好处。

### Ability to get up and running quickly
由于整个数据库结构是通过迁移在代码中定义的，因此任何开发人员都可以打开该项目，验证连接字符串是否有效，并运行一个简单的命令，以在当前部署的任何环境中以其所处的确切状态获取数据库的本地副本。显然，仍然需要处理数据，因为虽然一些数据可能会通过播种数据库来创建，但可能仍然会有许多数据表需要人工交互或存根在测试数据中。这与任何使用数据库的项目都会遇到的问题没有什么不同，即使是在传统方法中也是如此。

### A complete record of database changes in source control
如前所述，使用代码优先方法允许在代码中强制定义数据库的每一部分。随着数据库的结构和需求发生变化，这些更改在代码文件中实现，并创建并执行新的迁移以影响数据库上的更改。  
过去，您可能尝试过迁移并发现它们很棘手。事实上，当多个开发人员创建冲突的迁移时，EFCore 之前的迁移甚至可能会让您感到痛苦。在以前版本的 EF 中，即使多个开发人员创建的迁移没有冲突，如果另一个开发人员先推送他们的更改，您仍然被迫重新构建迁移，因为保存在数据库中的整体模型哈希码会不同且迁移的顺序很重要。使用 EFCore6，这些痛点中的大部分都已消除，尽管迁移冲突仍然可能发生，但它们主要是对相同数据库对象的冲突更改的结果，而不仅仅是因为两个或更多开发人员都在修改数据库架构。  
由于我们的代码是在这种方法中直接在项目中定义的，因此文件和更改都在源代码管理中进行了跟踪。不再需要使用一堆生成的和非生成的脚本来创建数据库项目，或者更糟的是，手动将脚本放入源代码管理并希望开发人员保持它们最新。  
对源代码控制进行更改是一个非常重要的优势，不应掉以轻心。如果驱动器和/或备份失败，总是有可能完全丢失您的数据库。即使您没有丢失数据库，当数据库发生故障时，您也可能会丢失自上次备份以来运行的所有事务。虽然数据库和备份故障同时发生的情况很少见，而且可能永远不会发生，但如果确实发生了，并且您仍然拥有项目代码，则可以运行迁移以从数据库中恢复结构和种子初始数据。实际上，此功能对于在开发人员的机器上快速建立应用程序数据更有用。一旦一个开发人员的更改进入您的开发人员源代码分支，其他开发人员就可以通过拉取更改并运行几个快速命令（例如 update-database）来更新他们自己的本地数据库。这在避免冲突和错误方面非常有利。  

### Agility when needing to revert to a previous state
由于代码在源代码管理中，EF 迁移还有一个额外的好处，如果编写正确，可以允许自动化轻松回滚对数据库的更改。回滚更改可能是一个破坏性的事件，会丢失数据，但这也是在生产中很少（如果有的话）进行的事情。事实上，存在一些用户根本不使用迁移回滚的阵营。该阵营的理论是，最好只添加另一个迁移以通过向前移动数据库来向后移动。无论哪种方式，无论您是允许回滚还是本质上进行恢复迁移，您仍然需要计划在这两种情况下如何影响数据。  
然而，通过回滚迁移的能力，可以非常容易地设置本地开发人员数据库以匹配数据库在任何开发点所处的确切状态。例如，很容易将数据库回滚到代码库出现错误或发布补丁时的状态。这允许像当时一样针对数据库进行有效编码，从而更轻松、更安全地发布跨项目所有正式版本的通用修改或修补错误修复。
迁移的另一个优点是可以随意恢复更改。例如，如果一个功能被发布，然后最终被淘汰，迁移允许该功能在补丁级别继续存在，但通过添加进一步的迁移来从未来的开发中删除，这些迁移基本上恢复了更改。拥有完整的数据库更改历史记录以及轻松将数据库重置为开发补丁或测试错误所需的状态的能力都由在特定迁移中生成和/或修改的代码管理。因此，作为开发人员，您不必花时间试图记住要运行和测试哪些脚本，以确保您的表和其他对象结构对于您正在处理的补丁、修复或功能是正确的。  

### Shifting from declarative to imperative database programming
使用代码优先数据库开发的另一个重要概念是，我们正在有意识地过渡到命令式数据库编程，并告别围绕我们数据库的声明式编程。  
命令式编程的概念是，作为开发人员，我们直接定义应该发生的事情，从而锁定实现的细节，几乎没有解释或实现的波动。  
无论您如何到达那里，声明式编程都会到达最终结果。在声明式范例中，只要实现了预期的最终结果，实施细节通常就不那么清晰和/或没有那么仔细审查。  
例如，围绕数据库开发的声明式方法可能看起来像您知道有一个表，其中包含在某处定义的一些数据。您可以查询该数据并可能连接到另一个表或视图以构建结果集，但只要数据显示出来，如何呈现它并不重要。此外，您可以依靠表中的某些字段来获取重要信息，例如姓名、年龄、出生日期、电子邮件，甚至可能是电话号码，但它可能已经更改，因此您最好在依靠之前仔细检查那个数据。如果数据不存在或已更改，也许您可​​以要求将重要信息存储在某个地方，然后有人可以构建数据库脚本，以便您最终可以获取它。  
命令式方法更加明确，代码优先本质上绝对是命令式的。每个数据库结构都在代码中精确建模。这意味着您确切地知道存在哪些表以及这些表上存在哪些字段。事实上，您可以轻松地创建一个模型实例，该实例包含完全正确的数据，具有数据库中存在的完全正确的限制，包括类型和任何其他约束，如长度或范围。此外，关系是直接定义的，因此您可以确定每个相关表中都存在外键，您可以轻松查询和填充相关数据。  
在大多数情况下，Entity Framework 始终具有一定的必要性，具有明确定义的结构。然而，代码优先方法巩固了命令式方法，它能够强制数据库符合特定要求，而不是依赖于可能在数据库中正确实现的东西。  

## It’s time to see code-first database programming in action
现在您已经了解了使用代码优先方法背后的一些优势和原因，是时候深入开展一些活动了。这些活动将帮助您更多地了解代码优先方法的工作原理，并了解它为您提供的使用这种方法的能力。您在这里看不到的一件事是，将代码优先放入成熟的现有项目（即具有 ADO.Net 的遗留应用程序或没有代码优先方法的早期版本的 EF）需要什么。这种情况下的总体方法与对现有数据库使用代码优先方法相同（如第一个活动所示）。在遗留系统中，随后需要更新代码以开始针对 EF 进行新开发和维护开发，并且原始连接和代码（例如 ADO.Net 实现）也将保留在原位，从而创建一种混合方法。在接下来的两个活动中，您将了解在 EFCore6 的新绿地项目中使用代码优先方法。您还将使用 EFCore6 针对成熟的数据库创建新的实现。

### A final thought before diving into the activities
在开始一些编码活动之前，我想花最后一点时间来确保其他一些事情是清楚的。我们将学习如何针对 EFCore6 中的现有数据库和新数据库利用实体框架。  
请注意，为了将重点放在 Entity Framework 的实际实现和使用上，我选择让启动项目在整本书中作为控制台应用程序工作。这种简单化的方法不太可能成为您的项目在现实世界中的运作方式。但是，学习如何制作 Web 控制器和在视图上显示数据，或将信息呈现给 Xamarin 表单，或其他类似的实践活动不在本书的范围之内。我相信，如果您是 Web 开发人员或 Xamarin 开发人员或 UWP 或 WPF 开发人员，您已经具备在这些领域所需的技能（或者您可能会在您的组织中获得可用于学习它们的资源）。因此，选择将这些活动的 GUI 部分限制为最少的实现是一个有意识的选择，这样做是为了允许专注于 EF 技术，而不是将桌面、设备或 Web 开发的细节混为一谈。  
然而，这种选择会带来很小的代价，我认为解决这个问题很重要。如果您在 WPF、UWP、Xamarin 和/或 ASP.Net MVC 中构建解决方案，那么这些项目模板很可能具有适当的工具，可以为您直接搭建实体框架的实现，因此请完成设置在许多情况下，可能没有必要以新的方式工作。您更有可能会遇到 EF 已经内置或由项目模板或您组织的技术架构师为您配置的项目。即便如此，学习如何从头开始构建解决方案将使您重新构建解决方案以实现更强大的实施，并让您接触到您需要了解的移动部分，以便拥有更坚实的基础在英孚。在这些活动结束时，您将可能拥有了解如何将 EFCore6 代码优先解决方案构建到任何新的 .Net 6 项目中所需的一切，无论您使用的是现有数据库还是新数据库。
